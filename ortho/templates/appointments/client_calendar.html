{% extends "website/base.html" %}
{% load static %}

{% block head %}
  <title>Calendar</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      corePlugins: {
        preflight: false,
      }
    }
  </script>

  <!-- Flowbite CSS -->
  <link href="{% static 'flowbite.min.css' %}" rel="stylesheet" />

{% endblock head %}

{% block content %}

<div class="max-w-5xl mx-auto py-6 px-4">
  <h3 class="text-center text-2xl font-semibold mb-6 text-gray-800">
    My Appointment Requests
  </h3>

  <!-- Legend -->
  <div class="flex justify-center space-x-4 mb-4">
    <span class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Approved</span>
    <span class="px-3 py-1 rounded-full bg-yellow-400 text-black text-sm">Pending</span>
  </div>

  <!-- Calendar container -->
  <div id="calendar" class="bg-white shadow-lg rounded-lg p-4 border border-gray-200"></div>
</div>


<!-- Tailwind Modal: Add / Request Event -->
<div id="addEventModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <!-- Background backdrop -->
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" id="modalBackdrop"></div>

    <!-- Center modal -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      
      <!-- Header -->
      <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900" id="modal-title">
            New Appointment Request
          </h3>
          <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="bg-white px-6 py-4">
        <form id="eventForm" class="space-y-4">

          <!-- Title -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventTitle">
              Title <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="eventTitle"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              required
            />
            <p class="mt-1 text-sm text-red-600 hidden" id="titleError">Please enter a title.</p>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDescription">
              Description (optional)
            </label>
            <textarea
              id="eventDescription"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>

          <!-- Date & Time -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDate">
                Date <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="eventDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <p class="mt-1 text-sm text-red-600 hidden" id="dateError">Select a date.</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="eventTime">
                Start time <span class="text-red-500">*</span>
              </label>
              <input
                type="time"
                id="eventTime"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <p class="mt-1 text-sm text-red-600 hidden" id="timeError">Select a start time.</p>
            </div>
          </div>

          <!-- Duration -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDuration">
              Duration
            </label>
            <select
              id="eventDuration"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="15">15 min</option>
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
              <option value="90">90 min</option>
            </select>
          </div>

          <!-- Hidden values -->
          <input type="hidden" id="hiddenStartIso">
          <input type="hidden" id="hiddenEndIso">
        </form>

        <!-- Alert message -->
        <div id="formAlert" class="mt-4 hidden"></div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
        <button
          type="button"
          id="cancelModalBtn"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button
          type="button"
          id="saveEventBtn"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
        >
          Send Request
        </button>
      </div>

    </div>
  </div>
</div>


<!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- Flowbite JS -->
<script src="{% static 'flowbite.min.js' %}"></script>

<!-- Calendar Script -->
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ----------------------
  // Helpers
  // ----------------------
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showAlert(message, type = 'danger') {
    const alertEl = document.getElementById('formAlert');
    const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
    alertEl.innerHTML = `<div class="border-l-4 p-4 ${bgColor}" role="alert"><p class="font-medium">${message}</p></div>`;
    alertEl.classList.remove('hidden');
    setTimeout(() => { alertEl.classList.add('hidden'); }, 4000);
  }

  // ----------------------
  // Modal & form elements
  // ----------------------
  const csrftoken = getCookie('csrftoken');
  const modal = document.getElementById('addEventModal');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const cancelModalBtn = document.getElementById('cancelModalBtn');
  const eventForm = document.getElementById('eventForm');
  const saveEventBtn = document.getElementById('saveEventBtn');

  const titleInput = document.getElementById('eventTitle');
  const descInput = document.getElementById('eventDescription');
  const dateInput = document.getElementById('eventDate');
  const timeInput = document.getElementById('eventTime');
  const durationSelect = document.getElementById('eventDuration');
  const hiddenStartIso = document.getElementById('hiddenStartIso');
  const hiddenEndIso = document.getElementById('hiddenEndIso');

  const titleError = document.getElementById('titleError');
  const dateError = document.getElementById('dateError');
  const timeError = document.getElementById('timeError');

  // Modal functions
  function openModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    clearValidation();
  }

  function clearValidation() {
    titleError.classList.add('hidden');
    dateError.classList.add('hidden');
    timeError.classList.add('hidden');
    titleInput.classList.remove('border-red-500');
    dateInput.classList.remove('border-red-500');
    timeInput.classList.remove('border-red-500');
    document.getElementById('formAlert').classList.add('hidden');
  }

  // Close modal on backdrop click
  modalBackdrop.addEventListener('click', closeModal);
  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  // ESC key to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  function openAddModal(prefillStartIso=null, prefillEndIso=null) {
    clearValidation();
    eventForm.reset();

    if (prefillStartIso) {
      const d = new Date(prefillStartIso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      timeInput.value = `${hh}:${mi}`;
    }

    if (prefillEndIso) {
      const s = new Date(prefillStartIso);
      const e = new Date(prefillEndIso);
      const minutes = Math.round((e - s) / 60000);
      const opt = Array.from(durationSelect.options).find(o => parseInt(o.value) === minutes);
      if (opt) durationSelect.value = opt.value;
    }

    hiddenStartIso.value = prefillStartIso || '';
    hiddenEndIso.value = prefillEndIso || '';
    openModal();
  }

  // ----------------------
  // Initialize FullCalendar
  // ----------------------
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    selectable: true,
    selectMirror: true,
    businessHours: true,
    height: 'auto',
    events: '/calendar/events/all/',
    select: function(info) {
      openAddModal(info.startStr, info.endStr || info.startStr);
    },
    eventClick: function(info) {
      const ev = info.event;
      const approved = ev.extendedProps.isApproved;
      const status = approved ? 'Approved' : 'Pending';
      const desc = ev.extendedProps.description || '';
      alert(`${ev.title}\n\n${status}\n\n${desc}\n\n${ev.start.toLocaleString()} â†’ ${ev.end ? ev.end.toLocaleString() : ''}`);
    }
  });

  calendar.render();

  // ----------------------
  // Form validation & submission
  // ----------------------
  saveEventBtn.addEventListener('click', async () => {
    clearValidation();
    let hasError = false;

    // Validate title
    if (!titleInput.value.trim()) {
      titleError.classList.remove('hidden');
      titleInput.classList.add('border-red-500');
      titleInput.focus();
      hasError = true;
    }

    // Validate date
    if (!dateInput.value) {
      dateError.classList.remove('hidden');
      dateInput.classList.add('border-red-500');
      hasError = true;
    }

    // Validate time
    if (!timeInput.value) {
      timeError.classList.remove('hidden');
      timeInput.classList.add('border-red-500');
      hasError = true;
    }

    if (hasError) return;

    // Assemble ISO strings
    const date = dateInput.value;
    const time = timeInput.value;
    const duration = parseInt(durationSelect.value, 10);

    const startLocal = new Date(`${date}T${time}`);
    if (isNaN(startLocal.getTime())) {
      showAlert('Invalid start date/time', 'danger');
      return;
    }
    const endLocal = new Date(startLocal.getTime() + duration * 60000);

    const payload = {
      title: titleInput.value.trim(),
      description: descInput.value.trim(),
      start: startLocal.toISOString(),
      end: endLocal.toISOString()
    };

    // Send to server
    try {
      const res = await fetch('/calendar/events/all/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });

      let data = null;
      try { data = await res.json(); } catch(e) { /* ignore */ }

      if (!res.ok) {
        const msg = (data && data.message) ? data.message : `Server returned ${res.status}`;
        showAlert('Error: ' + msg, 'danger');
        console.error('Server error adding event:', data || res.statusText);
        return;
      }

      // Success
      closeModal();
      calendar.refetchEvents();
      showAlert('Appointment request sent', 'success');

    } catch (err) {
      console.error('Fetch failed:', err);
      showAlert('Could not contact server', 'danger');
    }
  });
});
</script>
{% endblock %}
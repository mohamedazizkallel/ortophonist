{% extends "website/base.html" %}
{% load static %}

{% block head %}
  <title>Calendar</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      corePlugins: {
        preflight: false,
      }
    }
  </script>

  <!-- Flowbite CSS -->
  <link href="{% static 'flowbite.min.css' %}" rel="stylesheet" />
{% endblock head %}

{% block content %}

<div class="max-w-5xl mx-auto py-6 px-4">
  <h3 class="text-center text-2xl font-semibold mb-6 text-gray-800">
    {% if user.is_authenticated %}
      {{ user.get_full_name|default:user.username }}'s Appointment Requests
    {% else %}
      My Appointment Requests
    {% endif %}
  </h3>

  <!-- Legend -->
  <div class="flex justify-center space-x-4 mb-4">
    <span class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Approved</span>
    <span class="px-3 py-1 rounded-full bg-yellow-400 text-black text-sm">Pending</span>
  </div>

  <!-- Calendar container -->
  <div id="calendar" class="bg-white shadow-lg rounded-lg p-4 border border-gray-200"></div>
</div>


<!-- Tailwind Modal: Add / Request Event -->
<div id="addEventModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <!-- Background backdrop -->
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" id="modalBackdrop"></div>

    <!-- Center modal -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      
      <!-- Header -->
      <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900" id="modal-title">
            New Appointment Request
          </h3>
          <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Body -->
      <div class="bg-white px-6 py-4">
        <form id="eventForm" class="space-y-4">

          <!-- Title -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventTitle">
              Title <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="eventTitle"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              required
            />
            <p class="mt-1 text-sm text-red-600 hidden" id="titleError">Please enter a title.</p>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDescription">
              Description (optional)
            </label>
            <textarea
              id="eventDescription"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>

          <!-- Date & Time -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDate">
                Date <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="eventDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <p class="mt-1 text-sm text-red-600 hidden" id="dateError">Select a date.</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="eventTime">
                Start time <span class="text-red-500">*</span>
              </label>
              <input
                type="time"
                id="eventTime"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <p class="mt-1 text-sm text-red-600 hidden" id="timeError">Select a start time.</p>
            </div>
          </div>

          <!-- Duration -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="eventDuration">
              Duration
            </label>
            <select
              id="eventDuration"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="15">15 min</option>
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
              <option value="90">90 min</option>
            </select>
          </div>

          <!-- Hidden values -->
          <input type="hidden" id="hiddenStartIso">
          <input type="hidden" id="hiddenEndIso">
        </form>

        <!-- Alert message -->
        <div id="formAlert" class="mt-4 hidden"></div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
        <button
          type="button"
          id="cancelModalBtn"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button
          type="button"
          id="saveEventBtn"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
        >
          Send Request
        </button>
      </div>

    </div>
  </div>
</div>


<!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- Flowbite JS -->
<script src="{% static 'flowbite.min.js' %}"></script>

<!-- Calendar Script -->
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ----------------------
  // Helpers
  // ----------------------
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showAlert(message, type = 'danger') {
    const alertEl = document.getElementById('formAlert');
    const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
    alertEl.innerHTML = `<div class="border-l-4 p-4 ${bgColor}" role="alert"><p class="font-medium">${message}</p></div>`;
    alertEl.classList.remove('hidden');
    setTimeout(() => { alertEl.classList.add('hidden'); }, 4000);
  }

  // Toast notification system
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
    const icon = type === 'success' 
      ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>'
      : '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>';
    
    toast.className = `fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out flex items-center space-x-3 max-w-md`;
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px)';
    
    toast.innerHTML = `
      <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        ${icon}
      </svg>
      <p class="font-medium">${message}</p>
      <button class="ml-4 text-white hover:text-gray-200 focus:outline-none" onclick="this.parentElement.remove()">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  // ----------------------
  // Modal & form elements
  // ----------------------
  const csrftoken = getCookie('csrftoken');
  const modal = document.getElementById('addEventModal');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const cancelModalBtn = document.getElementById('cancelModalBtn');
  const eventForm = document.getElementById('eventForm');
  const saveEventBtn = document.getElementById('saveEventBtn');

  const titleInput = document.getElementById('eventTitle');
  const descInput = document.getElementById('eventDescription');
  const dateInput = document.getElementById('eventDate');
  const timeInput = document.getElementById('eventTime');
  const durationSelect = document.getElementById('eventDuration');
  const hiddenStartIso = document.getElementById('hiddenStartIso');
  const hiddenEndIso = document.getElementById('hiddenEndIso');

  const titleError = document.getElementById('titleError');
  const dateError = document.getElementById('dateError');
  const timeError = document.getElementById('timeError');

  // Modal functions
  function openModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    clearValidation();
  }

  function clearValidation() {
    titleError.classList.add('hidden');
    dateError.classList.add('hidden');
    timeError.classList.add('hidden');
    titleInput.classList.remove('border-red-500');
    dateInput.classList.remove('border-red-500');
    timeInput.classList.remove('border-red-500');
    document.getElementById('formAlert').classList.add('hidden');
  }

  // Close modal on backdrop click
  modalBackdrop.addEventListener('click', closeModal);
  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  // ESC key to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  function openAddModal(prefillStartIso=null, prefillEndIso=null) {
    clearValidation();
    eventForm.reset();

    // Pre-fill title with user's name
    {% if user.is_authenticated %}
    titleInput.value = "{{ user.get_full_name|default:user.username }}";
    {% endif %}

    if (prefillStartIso) {
      const d = new Date(prefillStartIso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      timeInput.value = `${hh}:${mi}`;
    }

    if (prefillEndIso) {
      const s = new Date(prefillStartIso);
      const e = new Date(prefillEndIso);
      const minutes = Math.round((e - s) / 60000);
      const opt = Array.from(durationSelect.options).find(o => parseInt(o.value) === minutes);
      if (opt) durationSelect.value = opt.value;
    }

    hiddenStartIso.value = prefillStartIso || '';
    hiddenEndIso.value = prefillEndIso || '';
    openModal();
  }

  // ----------------------
  // Initialize FullCalendar
  // ----------------------
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    slotMinTime: '07:00:00',  // Start at 7 AM
    slotMaxTime: '19:00:00',  // End at 7 PM
    allDaySlot: false,        // Hide all-day row
    selectable: true,
    selectMirror: true,
    selectConstraint: {
      start: '07:00',
      end: '19:00'
    },
    businessHours: {
      daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
      startTime: '07:00',
      endTime: '19:00'
    },
    height: 'auto',
    events: '/calendar/events/all/',
    
    // Custom event rendering based on user permissions
    eventDidMount: function(info) {
      const isStaffOrAdmin = {{ user.is_staff|yesno:"true,false" }} || {{ user.is_superuser|yesno:"true,false" }};
      
      if (!isStaffOrAdmin) {
        // For regular users, only show that time slot is taken
        info.el.querySelector('.fc-event-title').textContent = 'Booked';
        info.el.style.cursor = 'not-allowed';
      }
    },
    
    select: function(info) {
      openAddModal(info.startStr, info.endStr || info.startStr);
    },
    
    eventClick: function(info) {
      const ev = info.event;
      const isStaffOrAdmin = {{ user.is_staff|yesno:"true,false" }} || {{ user.is_superuser|yesno:"true,false" }};
      
      if (isStaffOrAdmin) {
        // Staff/Admin can see full details
        const approved = ev.extendedProps.isApproved;
        const status = approved ? 'Approved' : 'Pending';
        const desc = ev.extendedProps.description || 'No description';
        const creator = ev.extendedProps.createdBy || 'Unknown';
        const startTime = ev.start.toLocaleString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric', 
          hour: 'numeric', 
          minute: '2-digit' 
        });
        const endTime = ev.end ? ev.end.toLocaleString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit' 
        }) : '';
        
        showToast(`<strong>${ev.title}</strong><br>
                   Status: ${status}<br>
                   Created by: ${creator}<br>
                   ${desc}<br>
                   ${startTime} - ${endTime}`, 'info');
      } else {
        // Regular users only see that it's booked
        const startTime = ev.start.toLocaleString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric', 
          hour: 'numeric', 
          minute: '2-digit' 
        });
        const endTime = ev.end ? ev.end.toLocaleString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit' 
        }) : '';
        
        showToast(`This time slot is booked<br>${startTime} - ${endTime}`, 'info');
      }
    }
  });

  calendar.render();

  // ----------------------
  // Form validation & submission
  // ----------------------
  saveEventBtn.addEventListener('click', async () => {
    clearValidation();
    let hasError = false;

    // Validate title
    if (!titleInput.value.trim()) {
      titleError.classList.remove('hidden');
      titleInput.classList.add('border-red-500');
      titleInput.focus();
      hasError = true;
    }

    // Validate date
    if (!dateInput.value) {
      dateError.classList.remove('hidden');
      dateInput.classList.add('border-red-500');
      hasError = true;
    }

    // Validate time
    if (!timeInput.value) {
      timeError.classList.remove('hidden');
      timeInput.classList.add('border-red-500');
      hasError = true;
    }

    if (hasError) return;

    // Assemble ISO strings
    const date = dateInput.value;
    const time = timeInput.value;
    const duration = parseInt(durationSelect.value, 10);

    const startLocal = new Date(`${date}T${time}`);
    if (isNaN(startLocal.getTime())) {
      showAlert('Invalid start date/time', 'danger');
      return;
    }
    const endLocal = new Date(startLocal.getTime() + duration * 60000);

    const payload = {
      title: titleInput.value.trim(),
      description: descInput.value.trim(),
      start: startLocal.toISOString(),
      end: endLocal.toISOString()
    };

    // Send to server
    try {
      const res = await fetch('/calendar/events/all/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });

      let data = null;
      const contentType = res.headers.get('content-type');
      
      // Try to parse JSON response
      if (contentType && contentType.includes('application/json')) {
        try { 
          data = await res.json(); 
        } catch(e) { 
          console.error('JSON parse error:', e);
        }
      }

      if (!res.ok) {
        // Extract error message from response
        let errorMsg = 'An error occurred';
        
        if (data && data.message) {
          errorMsg = data.message;
        } else if (data && data.status === 'error') {
          errorMsg = data.message || 'Request failed';
        } else if (res.status === 409) {
          errorMsg = data?.message || 'This time slot is already booked.';
        } else if (res.status === 400) {
          errorMsg = 'Invalid request. Please check your input.';
        } else if (res.status === 403) {
          errorMsg = 'You do not have permission to perform this action.';
        } else {
          errorMsg = `Server error (${res.status})`;
        }
        
        showToast(errorMsg, 'error');
        console.error('Server error adding event:', data || res.statusText);
        return;
      }

      // Success
      closeModal();
      calendar.refetchEvents();
      showToast('Appointment request sent successfully!', 'success');

    } catch (err) {
      console.error('Network error:', err);
      showToast('Could not connect to server. Please check your connection.', 'error');
    }
  });
});
</script>
{% endblock %}
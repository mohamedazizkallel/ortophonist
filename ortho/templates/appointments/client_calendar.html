{% extends "website/base.html" %}
{% load static %}

{% block head %}
  <title>Callendar</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Flowbite (Tailwind) CSS -->
  <link href="{% static 'flowbite.min.css' %}" rel="stylesheet">

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">

{% endblock head %}

{% block content %}

<!-- Tailwind CDN (safe to use with Bootstrap) -->
<script src="https://cdn.tailwindcss.com"></script>

<div class="max-w-5xl mx-auto py-6 px-4">
  <h3 class="text-center text-2xl font-semibold mb-6 text-gray-800">
    My Appointment Requests
  </h3>

  <!-- Legend -->
  <div class="flex justify-center space-x-4 mb-4">
    <span class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Approved</span>
    <span class="px-3 py-1 rounded-full bg-yellow-400 text-black text-sm">Pending</span>
  </div>

  <!-- Calendar container -->
  <div id="calendar" class="bg-white shadow-lg rounded-lg p-4 border border-gray-200"></div>
</div>


<!-- Modal: Add / Request Event -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">

    <div class="modal-content rounded-xl shadow-2xl border-0">

      <!-- Header -->
      <div class="modal-header bg-gray-100 rounded-t-xl border-b">
        <h5 class="modal-title font-semibold text-lg" id="addEventModalLabel">
          New Appointment Request
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body bg-white">

        <form id="eventForm" class="space-y-4" novalidate>

          <!-- Title -->
          <div>
            <label class="block text-gray-700 font-medium mb-1" for="eventTitle">
              Title
            </label>
            <input
              type="text"
              id="eventTitle"
              class="form-control rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
              required
            />
            <div class="invalid-feedback">Please enter a title.</div>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-gray-700 font-medium mb-1" for="eventDescription">
              Description (optional)
            </label>
            <textarea
              id="eventDescription"
              rows="2"
              class="form-control rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>

          <!-- Date & Time -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-medium mb-1" for="eventDate">
                Date
              </label>
              <input
                type="date"
                id="eventDate"
                class="form-control rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <div class="invalid-feedback">Select a date.</div>
            </div>

            <div>
              <label class="block text-gray-700 font-medium mb-1" for="eventTime">
                Start time
              </label>
              <input
                type="time"
                id="eventTime"
                class="form-control rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                required
              />
              <div class="invalid-feedback">Select a start time.</div>
            </div>
          </div>

          <!-- Duration -->
          <div>
            <label class="block text-gray-700 font-medium mb-1" for="eventDuration">
              Duration
            </label>
            <select
              id="eventDuration"
              class="form-select rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="15">15 min</option>
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
              <option value="90">90 min</option>
            </select>
          </div>

          <!-- Hidden values -->
          <input type="hidden" id="hiddenStartIso">
          <input type="hidden" id="hiddenEndIso">
        </form>

        <!-- Alert message -->
        <div id="formAlert" class="mt-2 hidden"></div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-gray-50 rounded-b-xl">
        <button
          type="button"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-800"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          id="saveEventBtn"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white"
        >
          Send Request
        </button>
      </div>

    </div>
  </div>
</div>


<!-- FullCalendar + Bootstrap JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your JS (unchanged) -->
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ----------------------
  // Helpers
  // ----------------------
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showAlert(message, type = 'danger') {
    const alertEl = document.getElementById('formAlert');
    alertEl.innerHTML = `<div class="alert alert-${type} alert-sm mb-0">${message}</div>`;
    alertEl.style.display = 'block';
    // hide after 4s
    setTimeout(() => { alertEl.style.display = 'none'; }, 4000);
  }

  // ----------------------
  // Modal & form elements
  // ----------------------
  const csrftoken = getCookie('csrftoken');
  let addEventModal = new bootstrap.Modal('#addEventModal', { backdrop: true, focus: true });
  const eventForm = document.getElementById('eventForm');
  const saveEventBtn = document.getElementById('saveEventBtn');

  const titleInput = document.getElementById('eventTitle');
  const descInput = document.getElementById('eventDescription');
  const dateInput = document.getElementById('eventDate');
  const timeInput = document.getElementById('eventTime');
  const durationSelect = document.getElementById('eventDuration');
  const hiddenStartIso = document.getElementById('hiddenStartIso');
  const hiddenEndIso = document.getElementById('hiddenEndIso');

  // ensure form.reset happens BEFORE filling fields (previous bug)
  function openAddModal(prefillStartIso=null, prefillEndIso=null) {
    eventForm.classList.remove('was-validated');
    eventForm.reset(); // reset first

    // if calendar provided a range, prefill date & time; else leave blank
    if (prefillStartIso) {
      const d = new Date(prefillStartIso);
      // local date (yyyy-mm-dd)
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      // local time (HH:MM)
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      timeInput.value = `${hh}:${mi}`;
    }

    if (prefillEndIso) {
      // compute duration to set selection if matches standard options
      const s = new Date(prefillStartIso);
      const e = new Date(prefillEndIso);
      const minutes = Math.round((e - s) / 60000);
      // try to set option if present
      const opt = Array.from(durationSelect.options).find(o => parseInt(o.value) === minutes);
      if (opt) durationSelect.value = opt.value;
    }

    hiddenStartIso.value = prefillStartIso || '';
    hiddenEndIso.value = prefillEndIso || '';
    addEventModal.show();
  }

  // ----------------------
  // Initialize FullCalendar
  // ----------------------
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',              // show hours by default
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    selectable: true,
    selectMirror: true,
    businessHours: true,
    height: 'auto',
    events: '/calendar/events/all/',          // your endpoint
    select: function(info) {
      // info.startStr/info.endStr are ISO strings
      // prefill modal with the range
      openAddModal(info.startStr, info.endStr || info.startStr);
    },
    eventClick: function(info) {
      // show detail popup for users (read-only) — can be improved
      const ev = info.event;
      const approved = ev.extendedProps.isApproved;
      const status = approved ? 'Approved' : 'Pending';
      const desc = ev.extendedProps.description || '';
      alert(`${ev.title}\n\n${status}\n\n${desc}\n\n${ev.start.toLocaleString()} → ${ev.end ? ev.end.toLocaleString() : ''}`);
    }
  });

  calendar.render();

  // ----------------------
  // Form submission
  // ----------------------
  saveEventBtn.addEventListener('click', async () => {
    // Bootstrap validation
    eventForm.classList.remove('was-validated');
    if (!titleInput.value.trim()) {
      titleInput.focus();
      eventForm.classList.add('was-validated');
      return;
    }
    if (!dateInput.value || !timeInput.value) {
      eventForm.classList.add('was-validated');
      return;
    }

    // assemble ISO strings in local timezone (browser)
    const date = dateInput.value;   // YYYY-MM-DD
    const time = timeInput.value;   // HH:MM
    const duration = parseInt(durationSelect.value, 10);

    const startLocal = new Date(`${date}T${time}`);
    if (isNaN(startLocal.getTime())) {
      showAlert('Invalid start date/time', 'danger');
      return;
    }
    const endLocal = new Date(startLocal.getTime() + duration * 60000);

    const payload = {
      title: titleInput.value.trim(),
      description: descInput.value.trim(),
      start: startLocal.toISOString(),
      end: endLocal.toISOString()
    };

    // send to server

  try {
    const res = await fetch('/calendar/events/all/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(payload)
    });

    let data = null;
    try { data = await res.json(); } catch(e) { /* ignore json parse */ }

    if (!res.ok) {
      const msg = (data && data.message) ? data.message : `Server returned ${res.status}`;
      showAlert('Error: ' + msg, 'danger');
      console.error('Server error adding event:', data || res.statusText);
      return;
    }

    // success
    addEventModal.hide();
    calendar.refetchEvents();
    showAlert('Appointment request sent', 'success');

  } catch (err) {
    console.error('Fetch failed:', err);
    showAlert('Could not contact server', 'danger');
  }

  });

  // Close modal => clear validation & alerts
  addEventModalEl.addEventListener('hidden.bs.modal', () => {
    eventForm.classList.remove('was-validated');
    document.getElementById('formAlert').style.display = 'none';
  });
});
</script>
{% endblock %}

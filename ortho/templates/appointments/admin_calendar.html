{% extends "website/base.html" %}
{% load static %}

{% block head %}
<title>Admin Calendar</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { corePlugins: { preflight: false } };
</script>

<!-- Flowbite CSS (optional) -->
<link href="{% static 'flowbite.min.css' %}" rel="stylesheet" />
{% endblock head %}

{% block content %}

<div class="max-w-5xl mx-auto py-6 px-4">
  <h3 class="text-center text-2xl font-semibold mb-6 text-gray-800">
    Clinic Appointment Calendar
  </h3>

  <!-- Legend -->
  <div class="flex justify-center space-x-4 mb-4">
    <span class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Approved</span>
    <span class="px-3 py-1 rounded-full bg-yellow-400 text-black text-sm">Pending</span>
  </div>

  <!-- Calendar container -->
  <div id="calendar" class="bg-white shadow-lg rounded-lg p-4 border border-gray-200"></div>
</div>

<!-- Tailwind Modal -->
<div id="eventModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 py-6 text-center">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="modalBackdrop"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-xl text-left shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">

      <!-- Header -->
      <div class="bg-gray-100 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900" id="modal-title">Event Details</h3>
        <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="px-6 py-4 space-y-2">
        <p><strong>Title:</strong> <span id="eventTitleText"></span></p>
        <p><strong>Start:</strong> <span id="eventStart"></span></p>
        <p><strong>End:</strong> <span id="eventEnd"></span></p>
        <p><strong>Status:</strong> <span id="eventStatus"></span></p>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
        <button id="approveBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Approve</button>
        <button id="deleteBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
        <button id="closeModalFooterBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = getCookie('csrftoken');

  const calendarEl = document.getElementById('calendar');
  const modalEl = document.getElementById('eventModal');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const closeModalFooterBtn = document.getElementById('closeModalFooterBtn');
  const approveBtn = document.getElementById('approveBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  const eventTitleText = document.getElementById('eventTitleText');
  const eventStart = document.getElementById('eventStart');
  const eventEnd = document.getElementById('eventEnd');
  const eventStatus = document.getElementById('eventStatus');

  let currentEventId = null;

  function openModal() {
    modalEl.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalEl.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }

  modalBackdrop.addEventListener('click', closeModal);
  closeModalBtn.addEventListener('click', closeModal);
  closeModalFooterBtn.addEventListener('click', closeModal);
  document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    selectable: true,
    editable: true,
    height: 'auto',
    events: '/calendar/events/all/',

    select(info) {
      const title = prompt('Add appointment title:');
      if (title) {
        fetch('/calendar/events/all/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ title, start: info.startStr, end: info.endStr })
        }).then(r => r.ok && calendar.refetchEvents());
      }
    },

    eventClick(info) {
      currentEventId = info.event.id;
      const isPending = info.event.backgroundColor === '#ffc107';

      eventTitleText.textContent = info.event.title;
      eventStart.textContent = new Date(info.event.start).toLocaleString();
      eventEnd.textContent = new Date(info.event.end).toLocaleString();
      eventStatus.innerHTML = isPending
        ? '<span class="px-2 py-1 bg-yellow-400 text-black rounded text-sm">Pending</span>'
        : '<span class="px-2 py-1 bg-green-600 text-white rounded text-sm">Approved</span>';

      approveBtn.style.display = isPending ? 'inline-block' : 'none';
      openModal();
    },

    eventDrop(info) { updateEvent(info.event); },
    eventResize(info) { updateEvent(info.event); }
  });

  calendar.render();

  approveBtn.addEventListener('click', () => {
    fetch(`/calendar/events/approve/${currentEventId}/`, { method: 'PATCH', headers: { 'X-CSRFToken': csrftoken }})
    .then(r => r.ok && (closeModal(), calendar.refetchEvents()));
  });

  deleteBtn.addEventListener('click', () => {
    if (!confirm('Are you sure you want to delete this event?')) return;
    fetch(`/calendar/events/delete/${currentEventId}/`, { method: 'DELETE', headers: { 'X-CSRFToken': csrftoken }})
    .then(r => r.ok && (closeModal(), calendar.refetchEvents()));
  });

  function updateEvent(event) {
    fetch(`/calendar/events/update/${event.id}/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({
        title: event.title,
        start: event.start.toISOString(),
        end: event.end ? event.end.toISOString() : event.start.toISOString()
      })
    }).then(r => r.ok && console.log('Event updated'));
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }
});
</script>

{% endblock %}

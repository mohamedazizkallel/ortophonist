{% extends "website/base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h3 class="text-center mb-4">Clinic Appointment Calendar</h3>

  <div id="calendar"></div>

  <p class="mt-3 text-center">
    <span class="badge bg-success">Approved</span>
    <span class="badge bg-warning text-dark">Pending</span>
  </p>
</div>

<!-- Modal for event actions -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="eventTitle">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Start:</strong> <span id="eventStart"></span></p>
        <p><strong>End:</strong> <span id="eventEnd"></span></p>
        <p><strong>Status:</strong> <span id="eventStatus"></span></p>
      </div>
      <div class="modal-footer">
        <button id="approveBtn" class="btn btn-success">Approve</button>
        <button id="deleteBtn" class="btn btn-danger">Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar & Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = getCookie('csrftoken');
  const calendarEl = document.getElementById('calendar');
  const modal = new bootstrap.Modal(document.getElementById('eventModal'));
  const titleEl = document.getElementById('eventTitle');
  const startEl = document.getElementById('eventStart');
  const endEl = document.getElementById('eventEnd');
  const statusEl = document.getElementById('eventStatus');
  const approveBtn = document.getElementById('approveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  let currentEventId = null;
  let isPending = false;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    editable: true,
    eventSources: [{ url: '/calendar/events/all/' }],
    height: 'auto',

    select(info) {
      const title = prompt('Add appointment title:');
      if (title) {
        fetch('/calendar/events/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
          body: JSON.stringify({ title, start: info.startStr, end: info.endStr })
        }).then(r => r.ok && calendar.refetchEvents());
      }
    },

    eventClick(info) {
      currentEventId = info.event.id;
      isPending = info.event.backgroundColor === '#ffc107'; // yellow = pending

      titleEl.textContent = info.event.title;
      startEl.textContent = new Date(info.event.start).toLocaleString();
      endEl.textContent = new Date(info.event.end).toLocaleString();
      statusEl.innerHTML = isPending
        ? '<span class="badge bg-warning text-dark">Pending</span>'
        : '<span class="badge bg-success">Approved</span>';

      approveBtn.style.display = isPending ? 'inline-block' : 'none';
      modal.show();
    },

    eventDrop(info) {
      updateEvent(info.event);
    },
    eventResize(info) {
      updateEvent(info.event);
    }
  });

  calendar.render();

  // Approve button
  approveBtn.addEventListener('click', () => {
    fetch(`/calendar/events/approve/${currentEventId}/`, {
      method: 'PATCH',
      headers: { 'X-CSRFToken': csrftoken },
    }).then(r => {
      if (r.ok) {
        modal.hide();
        calendar.refetchEvents();
      }
    });
  });

  // Delete button
  deleteBtn.addEventListener('click', () => {
    if (!confirm("Are you sure you want to delete this event?")) return;
    fetch(`/calendar/events/delete/${currentEventId}/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrftoken },
    }).then(r => {
      if (r.ok) {
        modal.hide();
        calendar.refetchEvents();
      }
    });
  });

  // Update events (drag or resize)
  function updateEvent(event) {
    fetch(`/calendar/events/update/${event.id}/`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        title: event.title,
        start: event.start.toISOString(),
        end: event.end ? event.end.toISOString() : event.start.toISOString(),
      })
    }).then(r => r.ok && console.log('Event updated'));
  }

  // CSRF util
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
